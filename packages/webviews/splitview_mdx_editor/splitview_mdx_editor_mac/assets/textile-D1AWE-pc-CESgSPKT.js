var s={addition:"inserted",attributes:"propertyName",bold:"strong",cite:"keyword",code:"monospace",definitionList:"list",deletion:"deleted",div:"punctuation",em:"emphasis",footnote:"variable",footCite:"qualifier",header:"heading",html:"comment",image:"atom",italic:"emphasis",link:"link",linkDefinition:"link",list1:"list",list2:"list.special",list3:"list",notextile:"string.special",pre:"operator",p:"content",quote:"bracket",span:"quote",specialChar:"character",strong:"strong",sub:"content.special",sup:"content.special",table:"variableName.special",tableHeading:"operator"};function b(e,t){t.mode=l.newLayout,t.tableHeading=!1,t.layoutType==="definitionList"&&t.spanningLayout&&e.match(r("definitionListEnd"),!1)&&(t.spanningLayout=!1)}function p(e,t,a){if(a==="_")return e.eat("_")?u(e,t,"italic",/__/,2):u(e,t,"em",/_/,1);if(a==="*")return e.eat("*")?u(e,t,"bold",/\*\*/,2):u(e,t,"strong",/\*/,1);if(a==="[")return e.match(/\d+\]/)&&(t.footCite=!0),o(t);if(a==="("){var i=e.match(/^(r|tm|c)\)/);if(i)return s.specialChar}if(a==="<"&&e.match(/(\w+)[^>]+>[^<]+<\/\1>/))return s.html;if(a==="?"&&e.eat("?"))return u(e,t,"cite",/\?\?/,2);if(a==="="&&e.eat("="))return u(e,t,"notextile",/==/,2);if(a==="-"&&!e.eat("-"))return u(e,t,"deletion",/-/,1);if(a==="+")return u(e,t,"addition",/\+/,1);if(a==="~")return u(e,t,"sub",/~/,1);if(a==="^")return u(e,t,"sup",/\^/,1);if(a==="%")return u(e,t,"span",/%/,1);if(a==="@")return u(e,t,"code",/@/,1);if(a==="!"){var c=u(e,t,"image",/(?:\([^\)]+\))?!/,1);return e.match(/^:\S+/),c}return o(t)}function u(e,t,a,i,c){var f=e.pos>c?e.string.charAt(e.pos-c-1):null,m=e.peek();if(t[a]){if((!m||/\W/.test(m))&&f&&/\S/.test(f)){var h=o(t);return t[a]=!1,h}}else(!f||/\W/.test(f))&&m&&/\S/.test(m)&&e.match(new RegExp("^.*\\S"+i.source+"(?:\\W|$)"),!1)&&(t[a]=!0,t.mode=l.attributes);return o(t)}function o(e){var t=d(e);if(t)return t;var a=[];return e.layoutType&&a.push(s[e.layoutType]),a=a.concat(y(e,"addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","strong","sub","sup","table","tableHeading")),e.layoutType==="header"&&a.push(s.header+"-"+e.header),a.length?a.join(" "):null}function d(e){var t=e.layoutType;switch(t){case"notextile":case"code":case"pre":return s[t];default:return e.notextile?s.notextile+(t?" "+s[t]:""):null}}function y(e){for(var t=[],a=1;a<arguments.length;++a)e[arguments[a]]&&t.push(s[arguments[a]]);return t}function g(e){var t=e.spanningLayout,a=e.layoutType;for(var i in e)e.hasOwnProperty(i)&&delete e[i];e.mode=l.newLayout,t&&(e.layoutType=a,e.spanningLayout=!0)}var n={cache:{},single:{bc:"bc",bq:"bq",definitionList:/- .*?:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},attributes:{align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/},createRe:function(e){switch(e){case"drawTable":return n.makeRe("^",n.single.drawTable,"$");case"html":return n.makeRe("^",n.single.html,"(?:",n.single.html,")*","$");case"linkDefinition":return n.makeRe("^",n.single.linkDefinition,"$");case"listLayout":return n.makeRe("^",n.single.list,r("allAttributes"),"*\\s+");case"tableCellAttributes":return n.makeRe("^",n.choiceRe(n.single.tableCellAttributes,r("allAttributes")),"+\\.");case"type":return n.makeRe("^",r("allTypes"));case"typeLayout":return n.makeRe("^",r("allTypes"),r("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return n.makeRe("^",r("allAttributes"),"+");case"allTypes":return n.choiceRe(n.single.div,n.single.foot,n.single.header,n.single.bc,n.single.bq,n.single.notextile,n.single.pre,n.single.table,n.single.para);case"allAttributes":return n.choiceRe(n.attributes.selector,n.attributes.css,n.attributes.lang,n.attributes.align,n.attributes.pad);default:return n.makeRe("^",n.single[e])}},makeRe:function(){for(var e="",t=0;t<arguments.length;++t){var a=arguments[t];e+=typeof a=="string"?a:a.source}return new RegExp(e)},choiceRe:function(){for(var e=[arguments[0]],t=1;t<arguments.length;++t)e[t*2-1]="|",e[t*2]=arguments[t];return e.unshift("(?:"),e.push(")"),n.makeRe.apply(null,e)}};function r(e){return n.cache[e]||(n.cache[e]=n.createRe(e))}var l={newLayout:function(e,t){if(e.match(r("typeLayout"),!1))return t.spanningLayout=!1,(t.mode=l.blockType)(e,t);var a;return d(t)||(e.match(r("listLayout"),!1)?a=l.list:e.match(r("drawTable"),!1)?a=l.table:e.match(r("linkDefinition"),!1)?a=l.linkDefinition:e.match(r("definitionList"))?a=l.definitionList:e.match(r("html"),!1)&&(a=l.html)),(t.mode=a||l.text)(e,t)},blockType:function(e,t){var a,i;if(t.layoutType=null,a=e.match(r("type")))i=a[0];else return(t.mode=l.text)(e,t);return(a=i.match(r("header")))?(t.layoutType="header",t.header=parseInt(a[0][1])):i.match(r("bq"))?t.layoutType="quote":i.match(r("bc"))?t.layoutType="code":i.match(r("foot"))?t.layoutType="footnote":i.match(r("notextile"))?t.layoutType="notextile":i.match(r("pre"))?t.layoutType="pre":i.match(r("div"))?t.layoutType="div":i.match(r("table"))&&(t.layoutType="table"),t.mode=l.attributes,o(t)},text:function(e,t){if(e.match(r("text")))return o(t);var a=e.next();return a==='"'?(t.mode=l.link)(e,t):p(e,t,a)},attributes:function(e,t){return t.mode=l.layoutLength,e.match(r("attributes"))?s.attributes:o(t)},layoutLength:function(e,t){return e.eat(".")&&e.eat(".")&&(t.spanningLayout=!0),t.mode=l.text,o(t)},list:function(e,t){var a=e.match(r("list"));t.listDepth=a[0].length;var i=(t.listDepth-1)%3;return i?i===1?t.layoutType="list2":t.layoutType="list3":t.layoutType="list1",t.mode=l.attributes,o(t)},link:function(e,t){return t.mode=l.text,e.match(r("link"))?(e.match(/\S+/),s.link):o(t)},linkDefinition:function(e){return e.skipToEnd(),s.linkDefinition},definitionList:function(e,t){return e.match(r("definitionList")),t.layoutType="definitionList",e.match(/\s*$/)?t.spanningLayout=!0:t.mode=l.attributes,o(t)},html:function(e){return e.skipToEnd(),s.html},table:function(e,t){return t.layoutType="table",(t.mode=l.tableCell)(e,t)},tableCell:function(e,t){return e.match(r("tableHeading"))?t.tableHeading=!0:e.eat("|"),t.mode=l.tableCellAttributes,o(t)},tableCellAttributes:function(e,t){return t.mode=l.tableText,e.match(r("tableCellAttributes"))?s.attributes:o(t)},tableText:function(e,t){return e.match(r("tableText"))?o(t):e.peek()==="|"?(t.mode=l.tableCell,o(t)):p(e,t,e.next())}};const k={name:"textile",startState:function(){return{mode:l.newLayout}},token:function(e,t){return e.sol()&&b(e,t),t.mode(e,t)},blankLine:g};export{k as textile};
