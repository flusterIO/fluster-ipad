function i(e,t){return new RegExp((t?"":"^")+"(?:"+e.join("|")+")"+(t?"$":"\\b"))}function o(e,t,r){return r.tokenize.push(e),e(t,r)}var d=/^(?:[-+/%|&^]|\*\*?|[<>]{2})/,F=/^(?:[=!]~|===|<=>|[<>=!]=?|[|&]{2}|~)/,g=/^(?:\[\][?=]?)/,I=/^(?:\.(?:\.{2})?|->|[?:])/,f=/^[a-z_\u009F-\uFFFF][a-zA-Z0-9_\u009F-\uFFFF]*/,h=/^[A-Z_\u009F-\uFFFF][a-zA-Z0-9_\u009F-\uFFFF]*/,w=i(["abstract","alias","as","asm","begin","break","case","class","def","do","else","elsif","end","ensure","enum","extend","for","fun","if","include","instance_sizeof","lib","macro","module","next","of","out","pointerof","private","protected","rescue","return","require","select","sizeof","struct","super","then","type","typeof","uninitialized","union","unless","until","when","while","with","yield","__DIR__","__END_LINE__","__FILE__","__LINE__"]),v=i(["true","false","nil","self"]),S=["def","fun","macro","class","module","struct","lib","enum","union","do","for"],A=i(S),E=["if","unless","case","while","until","begin","then"],T=i(E),x=["end","else","elsif","rescue","ensure"],Z=i(x),y=["\\)","\\}","\\]"],N=new RegExp("^(?:"+y.join("|")+")$"),_={def:b,fun:b,macro:O,class:c,module:c,struct:c,lib:c,enum:c,union:c},p={"[":"]","{":"}","(":")","<":">"};function z(e,t){if(e.eatSpace())return null;if(t.lastToken!="\\"&&e.match("{%",!1))return o(s("%","%"),e,t);if(t.lastToken!="\\"&&e.match("{{",!1))return o(s("{","}"),e,t);if(e.peek()=="#")return e.skipToEnd(),"comment";var r;if(e.match(f))return e.eat(/[?!]/),r=e.current(),e.eat(":")?"atom":t.lastToken=="."?"property":w.test(r)?(A.test(r)?!(r=="fun"&&t.blocks.indexOf("lib")>=0)&&!(r=="def"&&t.lastToken=="abstract")&&(t.blocks.push(r),t.currentIndent+=1):(t.lastStyle=="operator"||!t.lastStyle)&&T.test(r)?(t.blocks.push(r),t.currentIndent+=1):r=="end"&&(t.blocks.pop(),t.currentIndent-=1),_.hasOwnProperty(r)&&t.tokenize.push(_[r]),"keyword"):v.test(r)?"atom":"variable";if(e.eat("@"))return e.peek()=="["?o(m("[","]","meta"),e,t):(e.eat("@"),e.match(f)||e.match(h),"propertyName");if(e.match(h))return"tag";if(e.eat(":"))return e.eat('"')?o(k('"',"atom",!1),e,t):e.match(f)||e.match(h)||e.match(d)||e.match(F)||e.match(g)?"atom":(e.eat(":"),"operator");if(e.eat('"'))return o(k('"',"string",!0),e,t);if(e.peek()=="%"){var n="string",a=!0,u;if(e.match("%r"))n="string.special",u=e.next();else if(e.match("%w"))a=!1,u=e.next();else if(e.match("%q"))a=!1,u=e.next();else if(u=e.match(/^%([^\w\s=])/))u=u[1];else{if(e.match(/^%[a-zA-Z_\u009F-\uFFFF][\w\u009F-\uFFFF]*/))return"meta";if(e.eat("%"))return"operator"}return p.hasOwnProperty(u)&&(u=p[u]),o(k(u,n,a),e,t)}return(r=e.match(/^<<-('?)([A-Z]\w*)\1/))?o(D(r[2],!r[1]),e,t):e.eat("'")?(e.match(/^(?:[^']|\\(?:[befnrtv0'"]|[0-7]{3}|u(?:[0-9a-fA-F]{4}|\{[0-9a-fA-F]{1,6}\})))/),e.eat("'"),"atom"):e.eat("0")?(e.eat("x")?e.match(/^[0-9a-fA-F_]+/):e.eat("o")?e.match(/^[0-7_]+/):e.eat("b")&&e.match(/^[01_]+/),"number"):e.eat(/^\d/)?(e.match(/^[\d_]*(?:\.[\d_]+)?(?:[eE][+-]?\d+)?/),"number"):e.match(d)?(e.eat("="),"operator"):e.match(F)||e.match(I)?"operator":(r=e.match(/[({[]/,!1))?(r=r[0],o(m(r,p[r],null),e,t)):e.eat("\\")?(e.next(),"meta"):(e.next(),null)}function m(e,t,r,n){return function(a,u){if(!n&&a.match(e))return u.tokenize[u.tokenize.length-1]=m(e,t,r,!0),u.currentIndent+=1,r;var l=z(a,u);return a.current()===t&&(u.tokenize.pop(),u.currentIndent-=1,l=r),l}}function s(e,t,r){return function(n,a){return!r&&n.match("{"+e)?(a.currentIndent+=1,a.tokenize[a.tokenize.length-1]=s(e,t,!0),"meta"):n.match(t+"}")?(a.currentIndent-=1,a.tokenize.pop(),"meta"):z(n,a)}}function O(e,t){if(e.eatSpace())return null;var r;if(r=e.match(f)){if(r=="def")return"keyword";e.eat(/[?!]/)}return t.tokenize.pop(),"def"}function b(e,t){return e.eatSpace()?null:(e.match(f)?e.eat(/[!?]/):e.match(d)||e.match(F)||e.match(g),t.tokenize.pop(),"def")}function c(e,t){return e.eatSpace()?null:(e.match(h),t.tokenize.pop(),"def")}function k(e,t,r){return function(n,a){for(var u=!1;n.peek();)if(u)n.next(),u=!1;else{if(n.match("{%",!1))return a.tokenize.push(s("%","%")),t;if(n.match("{{",!1))return a.tokenize.push(s("{","}")),t;if(r&&n.match("#{",!1))return a.tokenize.push(m("#{","}","meta")),t;var l=n.next();if(l==e)return a.tokenize.pop(),t;u=r&&l=="\\"}return t}}function D(e,t){return function(r,n){if(r.sol()&&(r.eatSpace(),r.match(e)))return n.tokenize.pop(),"string";for(var a=!1;r.peek();)if(a)r.next(),a=!1;else{if(r.match("{%",!1))return n.tokenize.push(s("%","%")),"string";if(r.match("{{",!1))return n.tokenize.push(s("{","}")),"string";if(t&&r.match("#{",!1))return n.tokenize.push(m("#{","}","meta")),"string";a=r.next()=="\\"&&t}return"string"}}const L={name:"crystal",startState:function(){return{tokenize:[z],currentIndent:0,lastToken:null,lastStyle:null,blocks:[]}},token:function(e,t){var r=t.tokenize[t.tokenize.length-1](e,t),n=e.current();return r&&r!="comment"&&(t.lastToken=n,t.lastStyle=r),r},indent:function(e,t,r){return t=t.replace(/^\s*(?:\{%)?\s*|\s*(?:%\})?\s*$/g,""),Z.test(t)||N.test(t)?r.unit*(e.currentIndent-1):r.unit*e.currentIndent},languageData:{indentOnInput:i(y.concat(x),!0),commentTokens:{line:"#"}}};export{L as crystal};
